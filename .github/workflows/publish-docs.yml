name: publish-docs

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install doc tools
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen rsync curl
          sudo curl -L -o /usr/local/bin/mdox https://github.com/db7/mdox/releases/download/v0.1/mdox-v0.1-linux-amd64
          sudo chmod +x /usr/local/bin/mdox

      - name: Configure
        run: cmake -S . -B build

      - name: Build markdown
        run: cmake --build build --target markdown

      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Publish docs
        env:
          PUBLISH_REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/open-s4c/open-s4c.github.io.git
          PUBLISH_PROJECT: vatomic
        run: |
          set -e
          checkout_dir="${RUNNER_TEMP}/gh-pages"
          if [ "${{ github.event_name }}" = "push" ]; then
              version="${{ github.ref_name }}"
              scripts/publish-docs.sh --version "${version}" --docs-dir doc/api --checkout-dir "${checkout_dir}"
          else
              scripts/publish-docs.sh --main --docs-dir doc/api --checkout-dir "${checkout_dir}"
          fi
